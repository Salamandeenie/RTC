<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Host/Receiver</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }
        #ipDisplay, #errorMsg {
            font-size: 24px;
            margin-top: 20px;
        }
        #status {
            margin-top: 20px;
            font-size: 18px;
        }
        #connectInput {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div>
        <button id="getIPBtn">Get My IP</button>
        <div id="ipDisplay">Your IP: <span id="ip"></span></div>
        <input type="text" id="connectInput" placeholder="Enter target IP address" />
        <button id="connectBtn">Send 'I'm here' Signal</button>
        <button id="hostBtn">Host Mode (Listen for Signals)</button>
        <div id="status">Status: Not Connected</div>
        <div id="errorMsg" style="color: red;"></div>
    </div>

    <script>
        let myIP = '';
        let isHost = false;
        let connection = null;

        // Function to validate IP address
        function isValidIP(ip) {
            const ipPattern = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            return ipPattern.test(ip);
        }

        // Get the public IP address using WebRTC
        function getPublicIP() {
            return new Promise((resolve, reject) => {
                const peerConnection = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });

                // Create a data channel
                peerConnection.createDataChannel('dataChannel');

                // Create an offer and set the local description
                peerConnection.createOffer().then(offer => {
                    return peerConnection.setLocalDescription(offer);
                }).then(() => {
                    // Listen for ICE candidates
                    peerConnection.onicecandidate = event => {
                        if (event.candidate) {
                            const candidate = event.candidate.candidate;
                            const parts = candidate.split(' ');
                            const ip = parts[4]; // Extracting the IP address
                            if (isValidIP(ip)) {
                                myIP = ip; // Store the IP for later use
                                resolve(ip);
                                peerConnection.close(); // Close the connection after retrieving the IP
                            }
                        }
                    };
                }).catch(error => {
                    reject(error);
                });
            });
        }

        // Display the IP address
        document.getElementById('getIPBtn').onclick = () => {
            getPublicIP()
                .then(ip => {
                    document.getElementById('ip').textContent = ip;
                    document.getElementById('errorMsg').textContent = ''; // Clear any previous errors
                })
                .catch(error => {
                    document.getElementById('errorMsg').textContent = 'Error retrieving IP: ' + error.message;
                });
        };

        // Simulate sending a connection signal to a target peer
        document.getElementById('connectBtn').onclick = () => {
            const targetIP = document.getElementById('connectInput').value;
            const errorMsg = document.getElementById('errorMsg');
            errorMsg.textContent = ''; // Clear previous error messages

            if (!isValidIP(targetIP)) {
                errorMsg.textContent = 'Error: Invalid IP address format.';
                return;
            }

            // Simulate sending a connection signal
            sendConnectionSignal(targetIP);
        };

        // Function to simulate sending a connection signal
        function sendConnectionSignal(targetIP) {
            // Simulate receiving the "I'm here" signal
            if (targetIP !== myIP) { // Only simulate if the target IP is not the same as your own
                // Here we would normally send the signal over the network
                console.log("Signal sent to: " + targetIP); // Debug output

                // Simulate that the host received the signal
                receiveSignalFromPeer(targetIP);
            } else {
                document.getElementById('errorMsg').textContent = 'Error: You cannot connect to your own IP.';
            }
        }

        // Host mode: listen for incoming "I'm here" messages
        document.getElementById('hostBtn').onclick = () => {
            isHost = true;
            document.getElementById('status').textContent = 'Status: Hosting (Listening for Signals)';
            startListeningForSignals();
        };

        // Function to simulate listening for signals
        function startListeningForSignals() {
            // In a real implementation, you'd set up a network listener here.
            // Simulate receiving a signal after a delay for demonstration purposes.
            setInterval(() => {
                if (isHost) {
                    const targetIP = myIP; // Assume we're checking for our own IP for testing
                    console.log("Listening for signal from: " + targetIP); // Debug output
                    // Simulate a connection signal being received
                    receiveSignalFromPeer(targetIP);
                }
            }, 5000); // Check every 5 seconds
        }

        // Function to simulate receiving a signal from a peer
        function receiveSignalFromPeer(targetIP) {
            // Simulate the "I'm here" signal reception
            document.body.style.backgroundColor = 'lime'; // Change background to lime green
            document.getElementById('status').textContent = 'Status: Connected to ' + targetIP;
        }
    </script>
</body>
</html>
