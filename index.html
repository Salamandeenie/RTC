<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetplayJS Example</title>
    <script src="https://unpkg.com/netplayjs@0.4.1/dist/netplay.js"></script>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: black;
            overflow: hidden; /* Prevents scrollbars */
        }
        canvas {
            position: absolute;
            opacity: 1;
            transition: opacity 0.5s;
        }
        #controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1; /* Ensure buttons are above canvas */
        }
        button {
            margin: 10px;
            padding: 10px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="600" height="300"></canvas>
    <div id="controls">
        <button id="timeButton">Show Time</button>
        <button id="colorButton">Change Background Color</button>
    </div>

    <script>
        class SimpleGame extends netplayjs.RollbackGame {
            constructor() {
                super();
                this.color = 'black'; // Default background color
            }

            // Called when the game starts
            onStart() {
                this.setState({
                    color: this.color,
                });
            }

            // Handle incoming state updates
            onStateUpdate(state) {
                this.color = state.color; // Update color from state
            }

            // Draw the current state of the game to a canvas.
            draw(canvas) {
                const ctx = canvas.getContext("2d");
                ctx.fillStyle = this.color; // Use the chosen color
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            // Update the background color
            updateColor(color) {
                this.color = color;
                this.setState({ color }); // Update state
            }
        }

        // Initialize the game
        const gameInstance = new SimpleGame();
        
        // Setup canvas and controls
        const canvas = document.getElementById('gameCanvas');
        gameInstance.setup(canvas);

        // Wait for connections
        gameInstance.onConnected(() => {
            canvas.style.opacity = '0'; // Set canvas opacity to 0
        });

        // Set up button functionality
        document.getElementById('timeButton').addEventListener('click', () => {
            const now = new Date().toLocaleTimeString();
            gameInstance.sendMessage(`Current time: ${now}`);
            console.log(`Current time: ${now}`);
        });

        document.getElementById('colorButton').addEventListener('click', () => {
            const newColor = 'lime'; // Change to lime
            gameInstance.sendMessage(`Change color: ${newColor}`);
            gameInstance.updateColor(newColor); // Update color on all instances
            console.log(`Background color changed to: ${newColor}`);
        });

        // Handle incoming messages
        gameInstance.onMessage((message) => {
            if (message.startsWith('Current time:')) {
                console.log(message); // Log received time message
            } else if (message.startsWith('Change color:')) {
                const color = message.split(': ')[1];
                gameInstance.updateColor(color); // Update the color based on the message
            }
        });

        // Start the game instance
        gameInstance.start();
    </script>
</body>
</html>
